---
title: 短信接口防盗用
date: 2022-07-27 16:49:03
tags:
---


1. 校验 Referer 头部
2. 签名校验
3. mobile 参数可以略微进行 AES 加密等
4. IP + UA 限制次数
例如，使用 Redis 记录次数

假设 key 特定前缀是 code_send_limit_

key = code_send_limit_ + `<IP 和 UA 的混合>`
value = 次数

> incr  expireAt


```php
$key = "code_send_limit_{$mobile}";
$limit = $redis->get($key);

if ($limit === false) {
    $new_value = $redis->incr($key);
    if ($new_value == 1) {
        // 防止并发设置过期时间
        $redis->expire($key, 300);
    } elseif ($new_value > 5) {
        return '访问次数过多';
    }
} elseif ((int)$limit > 5) {
    return '访问次数过多';
} else {
    $new_value = $redis->incr($key);
    if ($new_value > 5) {
        return '访问次数过多';
    }
}


// 发送短信逻辑
state = sendMessage();
```